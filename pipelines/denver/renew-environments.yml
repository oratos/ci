resources:
  - name: daily
    type: time
    source:
      interval: 24h

jobs:
- name: renew-environments
  serial: true
  plan:
  - get: daily
    trigger: true
  - task: renew-environments
    tags: [cf-denver-shared-vsphere]
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: oratos/ci-base

      params:
        TOOLSMITHS_API_TOKEN: ((toolsmiths-api-token))

      run:
        path: /bin/bash
        args:
        - -c
        - |
          #!/bin/bash
          set -eu

          for env in $(curl https://environments.toolsmiths.cf-app.com/v1/custom_gcp/pks/list -G -d "api_token=${TOOLSMITHS_API_TOKEN}" | jq -r '.[] | select(.notes | contains("ahevenor")) | .name'); do
            curl --fail "https://environments.toolsmiths.cf-app.com/v1/custom_gcp/pks/renew" -H "Content-Type: application/json" -d @- <<JSON
            {
              "api_token": "${TOOLSMITHS_API_TOKEN}",
              "name": "${env}"
            }
          JSON
            echo
          done

