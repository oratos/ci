groups:
- name: main
  jobs:
  - unit-tests
  - build-sink-controller-image
  - build-event-controller-image
  - build-metric-controller-image
  - build-cert-generator-image
  - build-ghostunnel-image
  - build-sink-state-updater-image
  - build-telegraf-image
  - build-telegraf-windows-image
  - build-validator-image
  - build-observability-manager-image
  - deploy-gke
  - deploy-cfcr
  - gke-tests
  - cfcr-tests
  - promote
- name: release
  jobs:
  - release
  - update-bosh-release

resource_types:
- name: slack-notification
  type: docker-image
  source:
    repository: cfcommunity/slack-notification-resource
    tag: latest

- name: vault
  type: docker-image
  source:
    repository: wfernandes/vault-resource
    tag: latest

- name: gcs-resource
  type: docker-image
  source:
    repository: frodenas/gcs-resource

resources:
- name: oratos-ci
  type: git
  source:
    uri: https://github.com/pivotal-cf/oratos-ci
    branch: master

- name: sink-resources
  type: git
  source:
    uri: git@github.com:pivotal-cf/sink-resources
    branch: master
    private_key: ((github.oratos-bot-private-key))

- name: sink-controller-image
  type: docker-image
  source:
    repository: oratos/sink-controller
    username: ((docker-hub.username))
    password: ((docker-hub.password))

- name: event-controller-image
  type: docker-image
  source:
    repository: oratos/event-controller
    username: ((docker-hub.username))
    password: ((docker-hub.password))

- name: metric-controller-image
  type: docker-image
  source:
    repository: oratos/metric-controller
    username: ((docker-hub.username))
    password: ((docker-hub.password))

- name: fluent-bit-out-syslog-image
  type: docker-image
  source:
    repository: oratos/fluent-bit-out-syslog
    username: ((docker-hub.username))
    password: ((docker-hub.password))
    tag: release-elect

- name: cert-generator-image
  type: docker-image
  source:
    repository: oratos/cert-generator
    username: ((docker-hub.username))
    password: ((docker-hub.password))

- name: ghostunnel-image
  type: docker-image
  source:
    repository: oratos/ghostunnel
    username: ((docker-hub.username))
    password: ((docker-hub.password))

- name: sink-state-updater-image
  type: docker-image
  source:
    repository: oratos/sink-state-updater
    username: ((docker-hub.username))
    password: ((docker-hub.password))

- name: telegraf-image
  type: docker-image
  source:
    repository: oratos/telegraf
    username: ((docker-hub.username))
    password: ((docker-hub.password))

- name: validator-image
  type: docker-image
  source:
    repository: oratos/validator
    username: ((docker-hub.username))
    password: ((docker-hub.password))

- name: observability-manager-image
  type: docker-image
  source:
    repository: oratos/observability-manager
    username: ((docker-hub.username))
    password: ((docker-hub.password))

- name: out-syslog
  type: git
  source:
    uri: git@github.com:pivotal-cf/fluent-bit-out-syslog
    branch: master
    private_key: ((github.oratos-bot-private-key))

- name: slack-alert
  type: slack-notification
  source:
    url: ((slack.notifications-url))

- name: oratos-ci-testing-cfcr-bbl-state
  type: vault
  source:
    url: https://vault.oratos.ci.cf-app.com
    role_id: ((vault.role_id))
    secret_id: ((vault.secret_id))
    path: secret/envs/oratos-ci-testing-cfcr-bbl-state
    tarball: true

- name: sink-resources-github-release
  type: github-release
  source:
    owner: pivotal-cf
    repository: sink-resources
    access_token: ((github.oratos-bot-release-access-token))

- name: sink-resources-release
  type: git
  source:
    uri: git@github.com:pivotal-cf/sink-resources-release
    branch: master
    private_key: ((github.oratos-bot-private-key))

- name: sink-resources-release-github-release
  type: github-release
  source:
    owner: pivotal-cf
    repository: sink-resources-release
    access_token: ((github.oratos-bot-release-access-token))

- name: pks-releng-release-bucket
  type: gcs-resource
  source:
    bucket: pks-releng-final-releases
    json_key: ((pks-releng.gcp-json))
    regexp: '.*\.tgz'

jobs:
- name: unit-tests
  plan:
  - aggregate:
    - get: sink-resources
      trigger: true
    - get: oratos-ci
  - task: get-deps
    attempts: 3
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: oratos/ci-base
      inputs:
        - name: sink-resources
      outputs:
        - name: sink-resources-deps
      run:
        path: /bin/bash
        args:
          - "-c"
          - |
            #!/bin/bash
            set -Eeuo pipefail; [ -n "${DEBUG:-}" ] && set -x
            cwd="$PWD"
            cd "$cwd/sink-resources"
            go mod download
            rsync -avci /go/pkg "$cwd/sink-resources-deps"
  - aggregate:
    - task: run-linter
      file: oratos-ci/tasks/golangci-lint-modules/task.yml
      input_mapping:
        source-repo: sink-resources
        go-mod-deps: sink-resources-deps
      on_failure:
        put: slack-alert
        params:
          text: Sink Resources Linter failed
    - task: run-tests
      file: oratos-ci/tasks/go-test-mod/task.yml
      privileged: true
      input_mapping:
        source-repo: sink-resources
        go-mod-deps: sink-resources-deps
      params:
        PKGS_HOOK: |
          go list ./... | grep -v vendor | grep -v pkg/client
      on_failure:
        put: slack-alert
        params:
          text: Sink Resources Unit tests failed
    - task: run-verify-codegen
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: oratos/ci-base
        inputs:
        - name: sink-resources
          path: go/src/github.com/pivotal-cf/sink-resources
        params:
          DEBUG:
        run:
          path: /bin/bash
          args:
          - "-c"
          - |
            #!/bin/bash
            set -Eeuo pipefail; [ -n "${DEBUG:-}" ] && set -x

            export GOPATH="$PWD/go"
            pushd go/src/github.com/pivotal-cf/sink-resources/ > /dev/null
              hack/verify-codegen.sh
            popd > /dev/null
      on_failure:
        put: slack-alert
        params:
          text: Sink Resources Verify Codegen failed

- name: build-sink-controller-image
  serial: true
  plan:
  - aggregate:
    - get: sink-resources
      trigger: true
      passed:
      - unit-tests
    - get: oratos-ci
  - task: prepare-build
    file: oratos-ci/tasks/build-docker-image/task.yml
    input_mapping:
      source-repo: sink-resources
    params:
      DOCKERFILE: source-repo/cmd/sink-controller/Dockerfile
  - put: sink-controller-image
    params:
      build: build-image/build
      tag: build-image/tag
      cache: true
      cache_tag: latest
    get_params:
      skip_download: true

- name: build-event-controller-image
  serial: true
  plan:
  - aggregate:
    - get: sink-resources
      trigger: true
      passed:
      - unit-tests
    - get: oratos-ci
  - task: prepare-build
    file: oratos-ci/tasks/build-docker-image/task.yml
    input_mapping:
      source-repo: sink-resources
    params:
      DOCKERFILE: source-repo/cmd/event-controller/Dockerfile
  - put: event-controller-image
    params:
      build: build-image/build
      tag: build-image/tag
      cache: true
      cache_tag: latest
    get_params:
      skip_download: true

- name: build-metric-controller-image
  serial: true
  plan:
  - aggregate:
    - get: sink-resources
      trigger: true
      passed:
      - unit-tests
    - get: oratos-ci
  - task: prepare-build
    file: oratos-ci/tasks/build-docker-image/task.yml
    input_mapping:
      source-repo: sink-resources
    params:
      DOCKERFILE: source-repo/cmd/metric-controller/Dockerfile
  - put: metric-controller-image
    params:
      build: build-image/build
      tag: build-image/tag
      cache: true
      cache_tag: latest
    get_params:
      skip_download: true

- name: build-cert-generator-image
  serial: true
  plan:
  - aggregate:
    - get: sink-resources
      trigger: true
      passed:
      - unit-tests
    - get: oratos-ci
  - task: prepare-build
    file: oratos-ci/tasks/build-docker-image/task.yml
    input_mapping:
      source-repo: sink-resources
    params:
      DOCKERFILE: source-repo/cmd/cert-generator/Dockerfile
  - put: cert-generator-image
    params:
      build: build-image/build
      tag: build-image/tag
      cache: true
      cache_tag: latest
    get_params:
      skip_download: true

- name: build-ghostunnel-image
  serial: true
  plan:
  - aggregate:
    - get: sink-resources
      trigger: true
      passed:
      - unit-tests
    - get: oratos-ci
  - task: prepare-build
    file: oratos-ci/tasks/build-docker-image/task.yml
    input_mapping:
      source-repo: sink-resources
    params:
      SOURCE_PATH: cmd/ghostunnel
  - put: ghostunnel-image
    params:
      build: build-image/build
      tag: build-image/tag
      cache: true
      cache_tag: latest
    get_params:
      skip_download: true

- name: build-sink-state-updater-image
  serial: true
  plan:
  - aggregate:
    - get: sink-resources
      trigger: true
      passed:
      - unit-tests
    - get: oratos-ci
  - task: prepare-build
    file: oratos-ci/tasks/build-docker-image/task.yml
    input_mapping:
      source-repo: sink-resources
    params:
      DOCKERFILE: source-repo/cmd/sink-state-updater/Dockerfile
  - put: sink-state-updater-image
    params:
      build: build-image/build
      tag: build-image/tag
      cache: true
      cache_tag: latest
    get_params:
      skip_download: true

- name: build-telegraf-image
  serial: true
  plan:
  - aggregate:
    - get: sink-resources
      trigger: true
      passed:
      - unit-tests
    - get: oratos-ci
  - task: prepare-build
    file: oratos-ci/tasks/build-docker-image/task.yml
    input_mapping:
      source-repo: sink-resources
    params:
      DOCKERFILE: source-repo/cmd/telegraf/Dockerfile
  - put: telegraf-image
    params:
      build: build-image/build
      tag: build-image/tag
      cache: true
      cache_tag: latest
    get_params:
      skip_download: true

- name: build-telegraf-windows-image
  serial: true
  plan:
  - aggregate:
    - get: sink-resources
      trigger: true
      passed:
      - unit-tests
    - get: oratos-ci
  - task: build-windows-image
    input_mapping:
      source-repo: sink-resources
    config:
      inputs:
        - name: source-repo
      outputs:
        - name: build-image
      platform: windows
      params:
        DOCKER_USERNAME: ((docker-hub.username))
        DOCKER_PASSWORD: ((docker-hub.password))
        DOCKERFILE: source-repo/cmd/telegraf/Dockerfile-Windows
        EPHEMERAL_DISK_TEMP_PATH: "C:\\var\\vcap\\data\\tmp"
        IMAGE_NAME: "oratos/telegraf-windows"
      run:
        path: powershell
        args:
          - -Command
          - |
            $ProgressPreference="SilentlyContinue"
            $ErrorActionPreference = "Stop";
            trap { $host.SetShouldExit(1) }

            cd source-repo
            $sha = git rev-parse HEAD
            cd ..

            Set-Content -Path build-image/tag -Value "$sha"

            mkdir "$env:EPHEMERAL_DISK_TEMP_PATH" -ea 0
            $env:TEMP = $env:TMP = $env:GOTMPDIR = $env:EPHEMERAL_DISK_TEMP_PATH
            $env:GOCACHE = "$env:EPHEMERAL_DISK_TEMP_PATH\go-build"

            function Run-Docker {
              param([String[]] $cmd)

              docker @cmd
              if ($LASTEXITCODE -ne 0) {
                Exit $LASTEXITCODE
              }
            }

            restart-service docker

            mkdir buildDir
            cp $env:DOCKERFILE buildDir\Dockerfile

            cd buildDir

            Run-Docker "--version"
            Run-Docker "build", "-t", "${env:IMAGE_NAME}:$sha", "--pull", "."
            Run-Docker "images", "-a"
            Run-Docker "login", "-u", "$env:DOCKER_USERNAME", "-p", "$env:DOCKER_PASSWORD"
            Run-Docker "push", "${env:IMAGE_NAME}:$sha"

            # Run-Docker "save", "-o", "../build-image/image.tar", "${env:IMAGE_NAME}:$sha"

- name: build-validator-image
  serial: true
  plan:
  - aggregate:
    - get: sink-resources
      trigger: true
      passed:
      - unit-tests
    - get: oratos-ci
  - task: prepare-build
    file: oratos-ci/tasks/build-docker-image/task.yml
    input_mapping:
      source-repo: sink-resources
    params:
      DOCKERFILE: source-repo/cmd/validator/Dockerfile
  - put: validator-image
    params:
      build: build-image/build
      tag: build-image/tag
      cache: true
      cache_tag: latest
    get_params:
      skip_download: true

- name: build-observability-manager-image
  plan:
    - aggregate:
        - get: sink-resources
          trigger: true
          passed:
            - unit-tests
        - get: oratos-ci
        - get: out-syslog
    - task: prepare-image-with-manifest
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: oratos/ci-base
        inputs:
          - name: sink-resources
          - name: out-syslog
        outputs:
          - name: sink-resources-with-manifest
        run:
          path: /bin/bash
          args:
            - "-c"
            - |
              #!/bin/bash
              SR_SHA="$(cd sink-resources && git rev-parse @)"
              FLUENT_SHA="$(cd out-syslog && git rev-parse @)"
              ./sink-resources/hack/generate-pks-manifest.sh "$SR_SHA" "$FLUENT_SHA" > sink-resources/cmd/observability-manager/manifest.yaml
              rsync -avci sink-resources/ ./sink-resources-with-manifest/
    - task: prepare-build
      file: oratos-ci/tasks/build-docker-image/task.yml
      input_mapping:
        source-repo: sink-resources-with-manifest
      params:
        DOCKERFILE: source-repo/cmd/observability-manager/Dockerfile
    - put: observability-manager-image
      params:
        build: build-image/build
        tag: build-image/tag
        tag_as_latest: true
        cache: true
        cache_tag: latest
      get_params:
        skip_download: true

- name: deploy-gke
  serial: true
  plan:
  - aggregate:
    - get: sink-resources
      trigger: true
      passed:
      - build-sink-controller-image
      - build-event-controller-image
      - build-metric-controller-image
      - build-cert-generator-image
      - build-ghostunnel-image
      - build-sink-state-updater-image
      - build-telegraf-image
      - build-telegraf-windows-image
      - build-validator-image
      - build-observability-manager-image
    - get: observability-manager-image
      passed:
        - build-observability-manager-image
      params:
        skip_download: true
    - get: sink-controller-image
      passed:
      - build-sink-controller-image
      params:
        skip_download: true
    - get: event-controller-image
      passed:
      - build-event-controller-image
      params:
        skip_download: true
    - get: metric-controller-image
      passed:
      - build-metric-controller-image
      params:
        skip_download: true
    - get: ghostunnel-image
      passed:
      - build-ghostunnel-image
      params:
        skip_download: true
    - get: sink-state-updater-image
      passed:
      - build-sink-state-updater-image
      params:
        skip_download: true
    - get: telegraf-image
      passed:
      - build-telegraf-image
      params:
        skip_download: true
    - get: validator-image
      passed:
      - build-validator-image
      params:
        skip_download: true
    - get: cert-generator-image
      passed:
      - build-cert-generator-image
      params:
        skip_download: true
    - get: fluent-bit-out-syslog-image
      params:
        skip_download: true
    - get: oratos-ci
  - task: clean-up-environment
    file: oratos-ci/tasks/clean-up-environment/task.yml
    input_mapping:
      # bbl-state is not needed for GKE, pass in oratos-ci as a NOOP
      bbl-state: oratos-ci
    params:
      SERVICE_ACCOUNT: ((gcloud.oratos-ci-testing-gke-service-account))
      GET_CREDENTIALS_HOOK: |
        echo "$SERVICE_ACCOUNT" > sa.json
        gcloud auth activate-service-account --key-file sa.json
        rm sa.json
        gcloud container clusters get-credentials oratos-ci-testing \
          --zone us-central1-a
  - task: deploy
    file: oratos-ci/tasks/deploy-sink-resources/task.yml
    input_mapping:
      # bbl-state is not needed for GKE, pass in oratos-ci as a NOOP
      bbl-state: oratos-ci
    params:
      SERVICE_ACCOUNT: ((gcloud.oratos-ci-testing-gke-service-account))
      GET_CREDENTIALS_HOOK: |
        echo "$SERVICE_ACCOUNT" > sa.json
        gcloud auth activate-service-account --key-file sa.json
        rm sa.json
        gcloud container clusters get-credentials oratos-ci-testing \
          --zone us-central1-a

- name: gke-tests
  serial: true
  plan:
  - aggregate:
    - get: sink-resources
      trigger: true
      passed:
      - deploy-gke
    - get: observability-manager-image
      passed:
        - deploy-gke
      params:
        skip_download: true
    - get: sink-controller-image
      passed:
      - deploy-gke
    - get: event-controller-image
      passed:
      - deploy-gke
      params:
        skip_download: true
    - get: metric-controller-image
      passed:
      - deploy-gke
      params:
        skip_download: true
    - get: cert-generator-image
      passed:
      - deploy-gke
      params:
        skip_download: true
    - get: ghostunnel-image
      passed:
      - deploy-gke
      params:
        skip_download: true
    - get: sink-state-updater-image
      passed:
      - deploy-gke
      params:
        skip_download: true
    - get: telegraf-image
      passed:
      - deploy-gke
      params:
        skip_download: true
    - get: validator-image
      passed:
      - deploy-gke
      params:
        skip_download: true
    - get: oratos-ci
  - task: run-crd-tests
    file: oratos-ci/tasks/run-crd-tests/task.yml
    input_mapping:
      # bbl-state is not needed for GKE, pass in oratos-ci as a NOOP
      bbl-state: oratos-ci
    params:
      SERVICE_ACCOUNT: ((gcloud.oratos-ci-testing-gke-service-account))
      GET_CREDENTIALS_HOOK: |
          echo "$SERVICE_ACCOUNT" > sa.json
          gcloud auth activate-service-account --key-file sa.json
          rm sa.json
          gcloud container clusters get-credentials oratos-ci-testing \
            --zone us-central1-a
  - task: e2e-test
    file: oratos-ci/tasks/sink-e2e/task.yml
    input_mapping:
      # bbl-state is not needed for GKE, pass in oratos-ci as a NOOP
      bbl-state: oratos-ci
    params:
      SERVICE_ACCOUNT: ((gcloud.oratos-ci-testing-gke-service-account))
      GET_CREDENTIALS_HOOK: |
          echo "$SERVICE_ACCOUNT" > sa.json
          gcloud auth activate-service-account --key-file sa.json
          rm sa.json
          gcloud container clusters get-credentials oratos-ci-testing \
            --zone us-central1-a

- name: deploy-cfcr
  serial: true
  plan:
  - aggregate:
    - get: sink-resources
      trigger: true
      passed:
      - build-sink-controller-image
      - build-event-controller-image
      - build-metric-controller-image
      - build-cert-generator-image
      - build-ghostunnel-image
      - build-sink-state-updater-image
      - build-telegraf-image
      - build-telegraf-windows-image
      - build-validator-image
      - build-observability-manager-image
    - get: observability-manager-image
      passed:
        - build-observability-manager-image
      params:
        skip_download: true
    - get: sink-controller-image
      passed:
      - build-sink-controller-image
      params:
        skip_download: true
    - get: event-controller-image
      passed:
      - build-event-controller-image
      params:
        skip_download: true
    - get: metric-controller-image
      passed:
      - build-metric-controller-image
      params:
        skip_download: true
    - get: cert-generator-image
      passed:
      - build-cert-generator-image
      params:
        skip_download: true
    - get: ghostunnel-image
      passed:
      - build-ghostunnel-image
      params:
        skip_download: true
    - get: sink-state-updater-image
      passed:
      - build-sink-state-updater-image
      params:
        skip_download: true
    - get: telegraf-image
      passed:
      - build-telegraf-image
      params:
        skip_download: true
    - get: validator-image
      passed:
      - build-validator-image
      params:
        skip_download: true
    - get: fluent-bit-out-syslog-image
      params:
        skip_download: true
    - get: oratos-ci-testing-cfcr-bbl-state
    - get: oratos-ci
  - task: clean-up-environment
    file: oratos-ci/tasks/clean-up-environment/task.yml
    input_mapping:
      bbl-state: oratos-ci-testing-cfcr-bbl-state
    params:
      GET_CREDENTIALS_HOOK: |
        BBL_STATE_DIR=bbl-state \
            oratos-ci/scripts/cfcr.sh get-credentials testing
  - task: deploy
    file: oratos-ci/tasks/deploy-sink-resources/task.yml
    input_mapping:
      bbl-state: oratos-ci-testing-cfcr-bbl-state
    params:
      GET_CREDENTIALS_HOOK: |
          BBL_STATE_DIR=bbl-state \
              oratos-ci/scripts/cfcr.sh get-credentials testing

- name: cfcr-tests
  serial: true
  plan:
  - aggregate:
    - get: sink-resources
      trigger: true
      passed:
      - deploy-cfcr
    - get: observability-manager-image
      passed:
        - deploy-cfcr
      params:
        skip_download: true
    - get: sink-controller-image
      trigger: true
      passed:
      - deploy-cfcr
      params:
        skip_download: true
    - get: event-controller-image
      trigger: true
      passed:
      - deploy-cfcr
      params:
        skip_download: true
    - get: metric-controller-image
      trigger: true
      passed:
      - deploy-cfcr
      params:
        skip_download: true
    - get: cert-generator-image
      trigger: true
      passed:
      - deploy-cfcr
      params:
        skip_download: true
    - get: ghostunnel-image
      trigger: true
      passed:
      - deploy-cfcr
      params:
        skip_download: true
    - get: sink-state-updater-image
      trigger: true
      passed:
      - deploy-cfcr
      params:
        skip_download: true
    - get: telegraf-image
      trigger: true
      passed:
      - deploy-cfcr
      params:
        skip_download: true
    - get: validator-image
      trigger: true
      passed:
      - deploy-cfcr
      params:
        skip_download: true
    - get: oratos-ci
    - get: oratos-ci-testing-cfcr-bbl-state
  - task: run-crd-tests
    file: oratos-ci/tasks/run-crd-tests/task.yml
    input_mapping:
      bbl-state: oratos-ci-testing-cfcr-bbl-state
    params:
      GET_CREDENTIALS_HOOK: |
        BBL_STATE_DIR=bbl-state \
            oratos-ci/scripts/cfcr.sh get-credentials testing
  - task: e2e-test
    file: oratos-ci/tasks/sink-e2e/task.yml
    input_mapping:
      bbl-state: oratos-ci-testing-cfcr-bbl-state
    params:
      GET_CREDENTIALS_HOOK: |
        BBL_STATE_DIR=bbl-state \
            oratos-ci/scripts/cfcr.sh get-credentials testing

- name: promote
  serial: true
  plan:
  - aggregate:
    - get: sink-resources
      trigger: true
      passed:
      - cfcr-tests
      - gke-tests
    - get: sink-controller-image
      passed:
      - cfcr-tests
      - gke-tests
      params:
        save: true
    - get: event-controller-image
      passed:
      - cfcr-tests
      - gke-tests
      params:
        save: true
    - get: metric-controller-image
      passed:
      - cfcr-tests
      - gke-tests
      params:
        save: true
    - get: cert-generator-image
      passed:
      - cfcr-tests
      - gke-tests
      params:
        save: true
    - get: ghostunnel-image
      passed:
      - cfcr-tests
      - gke-tests
      params:
        save: true
    - get: sink-state-updater-image
      passed:
      - cfcr-tests
      - gke-tests
      params:
        save: true
    - get: telegraf-image
      passed:
      - cfcr-tests
      - gke-tests
      params:
        save: true
    - get: validator-image
      passed:
      - cfcr-tests
      - gke-tests
      params:
        save: true
    - get: observability-manager-image
      passed:
      - cfcr-tests
      - gke-tests
      params:
        save: true
    - task: write-promote-tag
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: oratos/ci-base
        outputs:
        - name: promote
        params:
          DEBUG:
        run:
          path: /bin/bash
          args:
          - "-c"
          - |
            #!/bin/bash
            set -Eeuo pipefail; [ -n "${DEBUG:-}" ] && set -x

            echo "release-elect" > promote/tag
  - aggregate:
    - put: sink-controller-image
      params:
        load: sink-controller-image
        tag: promote/tag
        cache: true
        cache_tag: latest
      get_params:
        skip_download: true
    - put: event-controller-image
      params:
        load: event-controller-image
        tag: promote/tag
        cache: true
        cache_tag: latest
      get_params:
        skip_download: true
    - put: metric-controller-image
      params:
        load: metric-controller-image
        tag: promote/tag
        cache: true
        cache_tag: latest
      get_params:
        skip_download: true
    - put: cert-generator-image
      params:
        load: cert-generator-image
        tag: promote/tag
        cache: true
        cache_tag: latest
      get_params:
        skip_download: true
    - put: ghostunnel-image
      params:
        load: ghostunnel-image
        tag: promote/tag
        cache: true
        cache_tag: latest
      get_params:
        skip_download: true
    - put: sink-state-updater-image
      params:
        load: sink-state-updater-image
        tag: promote/tag
        cache: true
        cache_tag: latest
      get_params:
        skip_download: true
    - put: telegraf-image
      params:
        load: telegraf-image
        tag: promote/tag
        cache: true
        cache_tag: latest
      get_params:
        skip_download: true
    - put: validator-image
      params:
        load: validator-image
        tag: promote/tag
        cache: true
        cache_tag: latest
      get_params:
        skip_download: true
    - put: observability-manager-image
      params:
        load: observability-manager-image
        tag: promote/tag
        cache: true
        cache_tag: latest
      get_params:
        skip_download: true

- name: release
  serial: true
  plan:
  - get: sink-controller-image
  - get: event-controller-image
  - get: metric-controller-image
  - get: cert-generator-image
  - get: ghostunnel-image
  - get: sink-state-updater-image
  - get: telegraf-image
  - get: validator-image
  - get: observability-manager-image
  - task: release
    privileged: true
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: oratos/ci-base
      params:
        GIT_REF: ((sink_resource_release_params.GIT_REF))
        VERSION: ((sink_resource_release_params.VERSION))
        FLUENT_BIT_OUT_SYSLOG_VERSION: ((sink_resource_release_params.FLUENT_BIT_OUT_SYSLOG_VERSION))
        DOCKERHUB_USERNAME: ((docker-hub.username))
        DOCKERHUB_PASSWORD: ((docker-hub.password))
        GITHUB_PRIVATE_KEY: ((github.oratos-bot-private-key))
        DEBUG:
      outputs:
      - name: github-release
      run:
        path: /bin/bash
        args:
        - "-c"
        - |
          #!/bin/bash
          set -Eeuo pipefail; [ -n "${DEBUG:-}" ] && set -x

          if [ -z "$GIT_REF" ]; then
            echo GIT_REF param required
            exit 1
          fi
          if ! [[ "$VERSION" =~ v ]]; then
            echo VERSION param required to start with v
            exit 1
          fi
          if ! [[ "$FLUENT_BIT_OUT_SYSLOG_VERSION" =~ v ]]; then
            echo FLUENT_BIT_OUT_SYSLOG_VERSION param required to start with v
            exit 1
          fi

          # Note: this was copied from the docker-image-resource
          # https://github.com/concourse/docker-image-resource/blob/c725c6277ca2820016de1bfe2bdfabaad5fd5879/assets/common.sh#L4
          sanitize_cgroups() {
            mkdir -p /sys/fs/cgroup
            mountpoint -q /sys/fs/cgroup || \
              mount -t tmpfs -o uid=0,gid=0,mode=0755 cgroup /sys/fs/cgroup

            mount -o remount,rw /sys/fs/cgroup

            sed -e 1d /proc/cgroups | while read -r sys _ _ enabled; do
              if [ "$enabled" != "1" ]; then
                # subsystem disabled; skip
                continue
              fi

              grouping="$(cut -d: -f2 /proc/self/cgroup | grep "\\<$sys\\>")" || true
              if [ -z "$grouping" ]; then
                # subsystem not mounted anywhere; mount it on its own
                grouping="$sys"
              fi

              mountpoint="/sys/fs/cgroup/$grouping"

              mkdir -p "$mountpoint"

              # clear out existing mount to make sure new one is read-write
              if mountpoint -q "$mountpoint"; then
                umount "$mountpoint"
              fi

              mount -n -t cgroup -o "$grouping" cgroup "$mountpoint"

              if [ "$grouping" != "$sys" ]; then
                if [ -L "/sys/fs/cgroup/$sys" ]; then
                  rm "/sys/fs/cgroup/$sys"
                fi

                ln -s "$mountpoint" "/sys/fs/cgroup/$sys"
              fi
            done

            if ! test -e /sys/fs/cgroup/systemd ; then
              mkdir /sys/fs/cgroup/systemd
              mount -t cgroup -o none,name=systemd none /sys/fs/cgroup/systemd
            fi
          }
          sanitize_cgroups
          /usr/bin/dockerd &
          docker_pid=$!
          function cleanup {
            set +e
            kill -9 $docker_pid
            killall ssh-agent
          }
          trap cleanup EXIT

          echo waiting 10 seconds while docker starts up
          sleep 10

          mkdir -p ~/.ssh/
          ssh-keyscan github.com >> ~/.ssh/known_hosts 2> /dev/null
          eval "$(ssh-agent)"
          [ -n "${DEBUG:-}" ] && set +x
          echo "$GITHUB_PRIVATE_KEY" > key
          [ -n "${DEBUG:-}" ] && set -x
          chmod 0600 key
          ssh-add key
          rm key
          git clone git@github.com:pivotal-cf/sink-resources
          pushd sink-resources > /dev/null
            git checkout "$GIT_REF"
            git tag "$VERSION"
          popd > /dev/null

          pushd sink-resources/manifests/overlays/pks
            kustomize edit set imagetag "oratos/cert-generator:$VERSION"
            kustomize edit set imagetag "oratos/ghostunnel:$VERSION"
            kustomize edit set imagetag "oratos/sink-state-updater:$VERSION"
            kustomize edit set imagetag "oratos/telegraf:$VERSION"
            kustomize edit set imagetag "oratos/telegraf-windows:$VERSION"
            kustomize edit set imagetag "oratos/validator:$VERSION"
            kustomize edit set imagetag "oratos/fluent-bit-out-syslog:$FLUENT_BIT_OUT_SYSLOG_VERSION"
            kustomize edit set imagetag "oratos/sink-controller:$VERSION"
            kustomize edit set imagetag "oratos/event-controller:$VERSION"
            kustomize edit set imagetag "oratos/metric-controller:$VERSION"
          popd

          # TODO: Update sink-resources/hack/generate-pks-manifest.sh
          ./sink-resources/hack/generate-pks-manifest.sh "$VERSION" "$FLUENT_BIT_OUT_SYSLOG_VERSION" > github-release/pks-manifest.yaml
          echo "$VERSION" > github-release/name
          echo "$VERSION" > github-release/tag

          pushd sink-resources > /dev/null
            git reset --hard HEAD
          popd > /dev/null

          cat <<EOF > github-release/body
          These are the versions of the docker images used in this release:
          - [oratos/sink-controller][sink-controller]:$VERSION
          - [oratos/event-controller][event-controller]:$VERSION
          - [oratos/metric-controller][metric-controller]:$VERSION
          - [oratos/cert-generator][cert-generator]:$VERSION
          - [oratos/ghostunnel][ghostunnel]:$VERSION
          - [oratos/sink-state-updater][sink-state-updater]:$VERSION
          - [oratos/telegraf][telegraf]:$VERSION
          - [oratos/telegraf-windows][telegraf-windows]:$VERSION
          - [oratos/validator][validator]:$VERSION
          - [oratos/observability-manager][observability-manager]:$VERSION
          - [oratos/fluent-bit-out-syslog][fluent-bit-out-syslog]:$FLUENT_BIT_OUT_SYSLOG_VERSION

          [sink-controller]: https://hub.docker.com/r/oratos/sink-controller/
          [event-controller]: https://hub.docker.com/r/oratos/event-controller/
          [metric-controller]: https://hub.docker.com/r/oratos/metric-controller/
          [cert-generator]: https://hub.docker.com/r/oratos/cert-generator/
          [ghostunnel]: https://hub.docker.com/r/oratos/ghostunnel/
          [sink-state-updater]: https://hub.docker.com/r/oratos/sink-state-updater/
          [telegraf]: https://hub.docker.com/r/oratos/telegraf/
          [telegraf-windows]: https://hub.docker.com/r/oratos/telegraf-windows/
          [validator]: https://hub.docker.com/r/oratos/validator/
          [observability-manager]: https://hub.docker.com/r/oratos/observability-manager/
          [fluent-bit-out-syslog]: https://hub.docker.com/r/oratos/fluent-bit-out-syslog/
          EOF

          [ -n "${DEBUG:-}" ] && set +x
          echo "$DOCKERHUB_PASSWORD" \
            | docker login \
              --username "$DOCKERHUB_USERNAME" \
              --password-stdin
          [ -n "${DEBUG:-}" ] && set -x

          sc_docker_name="oratos/sink-controller:$VERSION"
          ec_docker_name="oratos/event-controller:$VERSION"
          mc_docker_name="oratos/metric-controller:$VERSION"
          cg_docker_name="oratos/cert-generator:$VERSION"
          gt_docker_name="oratos/ghostunnel:$VERSION"
          ssu_docker_name="oratos/sink-state-updater:$VERSION"
          t_docker_name="oratos/telegraf:$VERSION"
          tw_docker_name="oratos/telegraf-windows:$VERSION"
          vd_docker_name="oratos/validator:$VERSION"
          om_docker_name="oratos/observability-manager:$VERSION"
          fb_docker_name="oratos/fluent-bit-out-syslog:$FLUENT_BIT_OUT_SYSLOG_VERSION"

          docker pull "oratos/sink-controller:$GIT_REF"
          docker tag "oratos/sink-controller:$GIT_REF" "$sc_docker_name"
          docker tag "oratos/sink-controller:$GIT_REF" "oratos/sink-controller:latest"
          docker push "$sc_docker_name"
          docker push "oratos/sink-controller:latest"

          docker pull "oratos/event-controller:$GIT_REF"
          docker tag "oratos/event-controller:$GIT_REF" "$ec_docker_name"
          docker tag "oratos/event-controller:$GIT_REF" "oratos/event-controller:latest"
          docker push "$ec_docker_name"
          docker push "oratos/event-controller:latest"

          docker pull "oratos/metric-controller:$GIT_REF"
          docker tag "oratos/metric-controller:$GIT_REF" "$mc_docker_name"
          docker tag "oratos/metric-controller:$GIT_REF" "oratos/metric-controller:latest"
          docker push "$mc_docker_name"
          docker push "oratos/metric-controller:latest"

          docker pull "oratos/cert-generator:$GIT_REF"
          docker tag "oratos/cert-generator:$GIT_REF" "$cg_docker_name"
          docker tag "oratos/cert-generator:$GIT_REF" "oratos/cert-generator:latest"
          docker push "$cg_docker_name"
          docker push "oratos/cert-generator:latest"

          docker pull "oratos/ghostunnel:$GIT_REF"
          docker tag "oratos/ghostunnel:$GIT_REF" "$gt_docker_name"
          docker tag "oratos/ghostunnel:$GIT_REF" "oratos/ghostunnel:latest"
          docker push "$gt_docker_name"
          docker push "oratos/ghostunnel:latest"

          docker pull "oratos/sink-state-updater:$GIT_REF"
          docker tag "oratos/sink-state-updater:$GIT_REF" "$ssu_docker_name"
          docker tag "oratos/sink-state-updater:$GIT_REF" "oratos/sink-state-updater:latest"
          docker push "$ssu_docker_name"
          docker push "oratos/sink-state-updater:latest"

          docker pull "oratos/telegraf:$GIT_REF"
          docker tag "oratos/telegraf:$GIT_REF" "$t_docker_name"
          docker tag "oratos/telegraf:$GIT_REF" "oratos/telegraf:latest"
          docker push "$t_docker_name"
          docker push "oratos/telegraf:latest"

          docker pull "oratos/telegraf-windows:$GIT_REF"
          docker tag "oratos/telegraf-windows:$GIT_REF" "$tw_docker_name"
          docker tag "oratos/telegraf-windows:$GIT_REF" "oratos/telegraf-windows:latest"
          docker push "$tw_docker_name"
          docker push "oratos/telegraf-windows:latest"

          docker pull "oratos/validator:$GIT_REF"
          docker tag "oratos/validator:$GIT_REF" "$vd_docker_name"
          docker tag "oratos/validator:$GIT_REF" "oratos/validator:latest"
          docker push "$vd_docker_name"
          docker push "oratos/validator:latest"

          docker pull "oratos/observability-manager:$GIT_REF"
          docker tag "oratos/observability-manager:$GIT_REF" "$om_docker_name"
          docker tag "oratos/observability-manager:$GIT_REF" "oratos/observability-manager:latest"
          docker push "$om_docker_name"
          docker push "oratos/observability-manager:latest"

          docker pull "$fb_docker_name"
          docker save "$sc_docker_name" | gzip > "github-release/oratos_sink-controller:$VERSION.tgz"
          docker save "$ec_docker_name" | gzip > "github-release/oratos_event-controller:$VERSION.tgz"
          docker save "$mc_docker_name" | gzip > "github-release/oratos_metric-controller:$VERSION.tgz"
          docker save "$cg_docker_name" | gzip > "github-release/oratos_cert-generator:$VERSION.tgz"
          docker save "$gt_docker_name" | gzip > "github-release/oratos_ghostunnel:$VERSION.tgz"
          docker save "$ssu_docker_name" | gzip > "github-release/oratos_sink-state-updater:$VERSION.tgz"
          docker save "$t_docker_name" | gzip > "github-release/oratos_telegraf:$VERSION.tgz"
          docker save "$vd_docker_name" | gzip > "github-release/oratos_validator:$VERSION.tgz"
          docker save "$om_docker_name" | gzip > "github-release/oratos_observability-manager:$VERSION.tgz"
          docker save "$fb_docker_name" | gzip > "github-release/oratos_fluent-bit-out-syslog:$FLUENT_BIT_OUT_SYSLOG_VERSION.tgz"

          pushd sink-resources > /dev/null
            git push origin --tags
          popd > /dev/null
  - put: sink-resources-github-release
    params:
      name: github-release/name
      body: github-release/body
      tag: github-release/tag
      globs:
      - github-release/pks-manifest.yaml
      - github-release/*.tgz

- name: update-bosh-release
  plan:
  - do:
    - get: sink-resources-github-release
      trigger: true
      passed:
      - release
      version:
        tag: ((sink_resource_release_params.VERSION))
    - get: sink-resources-release
    - get: oratos-ci
  - task: update-bosh-release
    privileged: true
    file: oratos-ci/tasks/update-bosh-release/task.yml
    params:
      PRIVATE_YML: ((release.private_yml))
      SINK_RESOURCES_VERSION: ((sink_resource_release_params.VERSION))
      FLUENT_BIT_OUT_SYSLOG_VERSION: ((sink_resource_release_params.FLUENT_BIT_OUT_SYSLOG_VERSION))
      SINK_RESOURCES_RELEASE_VERSION: ((sink_resource_release_params.SINK_RESOURCES_RELEASE_VERSION))
  - do:
    - put: pks-releng-release-bucket
      params:
        file: bosh-release/binaries/*.tgz
    - put: sink-resources-release
      params:
        repository: put-sink-resources-release
        name: bosh-release/name
    - put: sink-resources-release-github-release
      params:
        name: bosh-release/name
        tag: bosh-release/tag
        globs:
        - bosh-release/binaries/*.tgz