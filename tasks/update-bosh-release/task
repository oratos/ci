#!/bin/bash
set -Eeuo pipefail; [ -n "${DEBUG:-}" ] && set -x

release_file="sink-resources-release.tgz"

git clone sink-resources-release put-sink-resources-release
pushd put-sink-resources-release
  echo "$PRIVATE_YML" > config/private.yml

  bosh sync-blobs

  echo "Clean old blobs"
  for b in $(bosh blobs --column="Path"); do
    echo "bosh remove-blob $b"
    bosh remove-blob "$b"
  done

  echo "Begin blob management"
  for file in ../sink-resources-github-release/*.tgz; do
    file_name=${file##*/}
    bosh add-blob "${file}" "container-images/${file_name}"
  done

  bosh upload-blobs

  echo "Create final release"
  bosh --non-interactive create-release \
       --final \
       --force \
       --tarball="${release_file}"

  version=$(yq r releases/sink-resources-release/index.yml --tojson \
                | jq -r ".builds[].version" \
                | sort --version-sort \
                | tail -n1)

  echo "Move build ${release_file} - ${version} to bosh-release/binaries"
  mkdir -p ../bosh-release/binaries
  mv "${release_file}" "../bosh-release/binaries/sink-resources-release-${version}.tgz"

  git add .
  git commit -m"CI bump sink resource release to ${version}"
popd

echo "$version" > bosh-release/name
echo "$version" > bosh-release/tag

ls -alth bosh-release/binaries
