#!/bin/bash
set -Eeuo pipefail; [ -n "${DEBUG:-}" ] && set -x

source "/opt/resource/common.sh"
start_docker 3 3
log_in $DOCKERHUB_USERNAME $DOCKERHUB_PASSWORD $CONTAINER_REPOSITORY

# compute sha for tagging the docker image
sha="$(cd sink-resources && git rev-parse @)"
image_name="$CONTAINER_REPOSITORY/$COMPONENT:$sha"

pushd sink-resources
  docker build \
    --build-arg BASE_IMAGE="$BASE_IMAGE" \
    --build-arg TELEGRAF_IMAGE="$CONTAINER_REPOSITORY/telegraf:$sha" \
    --build-arg GOLANG_SOURCE="$GOLANG_SOURCE" \
    --build-arg KUBECTL_SOURCE="$KUBECTL_SOURCE" \
    -f "cmd/$COMPONENT/Dockerfile" \
    . \
    -t "$image_name"
popd

docker save "$image_name" | gzip > "image-tarball/$COMPONENT-$sha.tgz"