#!/bin/bash
set -Eeuo pipefail; [ -n "${DEBUG:-}" ] && set -x

# compute sha for tagging the docker image
sha="$(cd sink-resources && git rev-parse @)"
image_name="$CONTAINER_REPOSITORY/$COMPONENT:$sha"

/usr/bin/dockerd &
docker_pid=$!
function cleanup {
set +e
kill -9 $docker_pid
killall ssh-agent
}
trap cleanup EXIT

pushd sink-resources
  docker build \
    --build-arg BASE_IMAGE="$BASE_IMAGE" \
    --build-arg TELEGRAF_IMAGE="$CONTAINER_REPOSITORY/telegraf:$sha" \
    --build-arg GOLANG_SOURCE="$GOLANG_SOURCE" \
    --build-arg KUBECTL_SOURCE="$KUBECTL_SOURCE" \
    -f "cmd/$COMPONENT/Dockerfile" \
    . \
    -t "$image_name"
popd

docker save "$image_name" | gzip > "image-tarball/$COMPONENT-$sha.tgz"